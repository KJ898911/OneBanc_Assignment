var cvpHandlers={canvasClickHandler:null,videoTimeUpdateHandler:null,videoCanPlayHandler:null,windowResizeHandler:null};var CanvasVideoPlayer=function(a){var b;this.options={framesPerSecond:25,hideVideo:true,autoplay:false,audio:false,timelineSelector:false,resetOnLastFrame:false,loop:false};for(b in a){this.options[b]=a[b]}this.video=this.options.videoSelector.get(0);this.canvas=this.options.canvasSelector.get(0);this.timeline=document.querySelector(this.options.timelineSelector);this.timelinePassed=document.querySelector(this.options.timelineSelector+"> div");if(this.options.audio){if(typeof(this.options.audio)==="string"){this.audio=document.querySelectorAll(this.options.audio)[0];if(!this.audio){console.error('Element for the "audio" not found');return}}else{this.audio=document.createElement("audio");this.audio.innerHTML=this.video.innerHTML;this.video.parentNode.insertBefore(this.audio,this.video);this.audio.load()}var c=/iPad|iPhone|iPod/.test(navigator.platform);if(c){this.options.autoplay=false}}this.ctx=this.canvas.getContext("2d");this.playing=false;this.resizeTimeoutReference=false;this.RESIZE_TIMEOUT=1000;this.init();this.bind()};CanvasVideoPlayer.prototype.init=function(){this.video.load();this.setCanvasSize();if(this.options.hideVideo){this.video.style.display="none"}};CanvasVideoPlayer.prototype.getOffset=function(c){var a,b,d;if(!c){return}b=c.getBoundingClientRect();if(b.width||b.height||c.getClientRects().length){d=c.ownerDocument;a=d.documentElement;return{top:b.top+window.pageYOffset-a.clientTop,left:b.left+window.pageXOffset-a.clientLeft}}};CanvasVideoPlayer.prototype.jumpTo=function(a){this.video.currentTime=this.video.duration*a;if(this.options.audio){this.audio.currentTime=this.audio.duration*a}};CanvasVideoPlayer.prototype.bind=function(){var a=this;this.canvas.addEventListener("click",cvpHandlers.canvasClickHandler=function(){a.playPause()});this.video.addEventListener("timeupdate",cvpHandlers.videoTimeUpdateHandler=function(){a.drawFrame();if(a.options.timelineSelector){a.updateTimeline()}});this.video.addEventListener("canplay",cvpHandlers.videoCanPlayHandler=function(){a.drawFrame()});if(this.video.readyState>=2){a.drawFrame()}if(a.options.autoplay){a.play()}if(a.options.timelineSelector){this.timeline.addEventListener("click",function(c){var d=c.clientX-a.getOffset(a.canvas).left;var b=d/a.timeline.offsetWidth;a.jumpTo(b)})}window.addEventListener("resize",cvpHandlers.windowResizeHandler=function(){clearTimeout(a.resizeTimeoutReference);a.resizeTimeoutReference=setTimeout(function(){a.setCanvasSize();a.drawFrame()},a.RESIZE_TIMEOUT)});this.unbind=function(){this.canvas.removeEventListener("click",cvpHandlers.canvasClickHandler);this.video.removeEventListener("timeupdate",cvpHandlers.videoTimeUpdateHandler);this.video.removeEventListener("canplay",cvpHandlers.videoCanPlayHandler);window.removeEventListener("resize",cvpHandlers.windowResizeHandler);if(this.options.audio){this.audio.parentNode.removeChild(this.audio)}}};CanvasVideoPlayer.prototype.updateTimeline=function(){var a=(this.video.currentTime*100/this.video.duration).toFixed(2);this.timelinePassed.style.width=a+"%"};CanvasVideoPlayer.prototype.setCanvasSize=function(){this.width=this.canvas.clientWidth;this.height=this.canvas.clientHeight;this.canvas.setAttribute("width",this.width);this.canvas.setAttribute("height",this.height)};CanvasVideoPlayer.prototype.play=function(){this.lastTime=Date.now();this.playing=true;this.loop();if(this.options.audio){this.audio.currentTime=this.video.currentTime;this.audio.play()}};CanvasVideoPlayer.prototype.pause=function(){this.playing=false;if(this.options.audio){this.audio.pause()}};CanvasVideoPlayer.prototype.stop=function(){this.playing=false;this.pause();this.video.currentTime=0};CanvasVideoPlayer.prototype.playPause=function(){if(this.playing){this.pause()}else{this.video.currentTime=0;this.play()}};CanvasVideoPlayer.prototype.loop=function(){var b=this;var c=Date.now();var a=(c-this.lastTime)/1000;if(a>=(1/this.options.framesPerSecond)){this.video.currentTime=this.video.currentTime+a;this.lastTime=c;if(this.audio&&Math.abs(this.audio.currentTime-this.video.currentTime)>0.3){this.audio.currentTime=this.video.currentTime}}if($(this.canvas).parent().attr("data-cover")!==undefined&&this.video.currentTime>0.5){$(this.canvas).parent().find(".hide-bg").css({opacity:"0"})}if(this.video.currentTime>=this.video.duration){this.playing=false;if(this.options.resetOnLastFrame===true){this.video.currentTime=0}if(this.options.loop===true){this.video.currentTime=0;this.play()}}if(this.playing){this.animationFrame=requestAnimationFrame(function(){b.loop()})}else{cancelAnimationFrame(this.animationFrame)}};CanvasVideoPlayer.prototype.drawFrame=function(){this.ctx.drawImage(this.video,0,0,this.width,this.height)};